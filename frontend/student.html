<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Timetable - Smart Timetable Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-50 text-gray-800 font-inter antialiased min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-pink-600 text-white shadow-md z-10 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="flex items-center group">
                        <i
                            class="fa-solid fa-arrow-left text-pink-200 group-hover:text-white transition-colors mr-3"></i>
                        <span class="font-bold text-xl tracking-tight">Student Portal</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <button
                        class="bg-pink-500 hover:bg-pink-400 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors border border-pink-400"
                        onclick="window.print()">
                        <i class="fa-solid fa-print mr-1"></i> Print/PDF
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full py-8 px-4 sm:px-6 lg:px-8">

        <div
            class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8 flex justify-between items-center bg-gradient-to-r from-white to-pink-50">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Class Schedule</h1>
                <p class="text-gray-500 text-sm">View your semester sequence of classes.</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-500 hidden" id="loading-spinner">
                    <i class="fa-solid fa-circle-notch fa-spin text-pink-600 mr-2"></i> Loading...
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 flex space-x-4 items-end">
            <div class="flex-1 max-w-sm">
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Semester</label>
                <select id="filter-entity"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm px-3 py-2 border outline-none bg-white">
                    <option value="">-- Loading --</option>
                </select>
            </div>
            <div>
                <button id="btn-apply-filter"
                    class="bg-pink-600 text-white px-6 py-2 rounded-md hover:bg-pink-700 transition-colors font-medium shadow-sm h-10">
                    View Schedule
                </button>
            </div>
        </div>

        <!-- Grid Container -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border-collapse table-fixed w-full">
                    <thead class="bg-pink-50">
                        <tr>
                            <th
                                class="w-24 px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-r border-gray-200">
                                Time</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-r border-gray-200">
                                Monday</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-r border-gray-200">
                                Tuesday</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-r border-gray-200">
                                Wednesday</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider border-r border-gray-200">
                                Thursday</th>
                            <th
                                class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Friday</th>
                        </tr>
                    </thead>
                    <tbody id="grid-body" class="bg-white divide-y divide-gray-200 text-center text-sm">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>

            <div id="empty-state"
                class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center flex-col z-10">
                <i class="fa-solid fa-moon text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500 font-medium">No schedule available or no active timetable found.</p>
            </div>
        </div>

    </main>

    <script src="app.js"></script>
    <script>
        let currentTimetable = null;
        let allSubjects = {};
        let allFaculties = {};
        let allClassrooms = {};
        let allSemesters = {};

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const START_HOUR = 9;
        const END_HOUR = 17;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                toggleSpinner(true);
                const [subs, facs, rooms, sems] = await Promise.all([
                    apiRequest('/subjects/'),
                    apiRequest('/faculties/'),
                    apiRequest('/classrooms/'),
                    apiRequest('/semesters/')
                ]);

                subs.forEach(s => allSubjects[s.id] = s);
                facs.forEach(f => allFaculties[f.id] = f);
                rooms.forEach(r => allClassrooms[r.id] = r);
                sems.forEach(s => allSemesters[s.id] = s);

                currentTimetable = await apiRequest(`/timetables/latest`);

                setupCustomFilters();
            } catch (e) {
                console.error(e);
                showToast("No active timetable found. Please check with admin.", "error");
                document.getElementById('empty-state').classList.remove('hidden');
            } finally {
                toggleSpinner(false);
            }
        });

        function toggleSpinner(show) {
            const s = document.getElementById('loading-spinner');
            if (show) s.classList.remove('hidden'); else s.classList.add('hidden');
        }

        function setupCustomFilters() {
            const fEntity = document.getElementById('filter-entity');
            const btn = document.getElementById('btn-apply-filter');

            fEntity.innerHTML = '';
            Object.values(allSemesters).forEach(item => {
                fEntity.innerHTML += `<option value="${item.id}">${item.name}</option>`;
            });

            btn.addEventListener('click', () => {
                if (currentTimetable) renderGrid('semester', parseInt(fEntity.value));
            });

            if (Object.values(allSemesters).length > 0 && currentTimetable) {
                fEntity.value = Object.values(allSemesters)[0].id;
                renderGrid('semester', parseInt(fEntity.value));
            } else if (!currentTimetable) {
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        function renderGrid(filterType, entityId) {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';

            let filteredSessions = currentTimetable.sessions ? currentTimetable.sessions.filter(s => {
                const sub = allSubjects[s.subject_id];
                return sub && sub.semester_id === entityId;
            }) : [];

            if (filteredSessions.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            let grid = {};
            for (let h = START_HOUR; h < END_HOUR; h++) {
                grid[h] = { "Monday": null, "Tuesday": null, "Wednesday": null, "Thursday": null, "Friday": null };
            }

            filteredSessions.forEach(session => {
                if (grid[session.start_time]) grid[session.start_time][session.day_of_week] = session;
            });

            for (let h = START_HOUR; h < END_HOUR; h++) {
                const tr = document.createElement('tr');

                const timeHeader = document.createElement('td');
                timeHeader.className = "py-3 px-2 border-r border-gray-200 bg-gray-50 font-medium text-gray-700 align-middle";
                const displayH = h > 12 ? h - 12 : h;
                const displayNext = (h + 1) > 12 ? (h + 1) - 12 : (h + 1);
                timeHeader.innerHTML = `${displayH}:00 ${h >= 12 ? 'PM' : 'AM'} - ${displayNext}:00 ${(h + 1) >= 12 ? 'PM' : 'AM'}`;
                tr.appendChild(timeHeader);

                DAYS.forEach(day => {
                    const td = document.createElement('td');
                    td.className = "p-2 border-r border-gray-200 h-24 align-top w-1/5 transition-colors hover:bg-gray-50";

                    const session = grid[h][day];
                    if (session) {
                        const sub = allSubjects[session.subject_id] || { name: 'Unknown' };
                        const room = allClassrooms[session.classroom_id] || { name: 'Unknown' };
                        const fac = allFaculties[session.faculty_id] || { name: 'TBD' };

                        td.innerHTML = `
                            <div class="h-full w-full bg-pink-50 border-l-4 border-pink-500 rounded px-2 py-1 text-left flex flex-col justify-center shadow-sm">
                                <div class="font-bold text-pink-900 text-sm truncate" title="${sub.name}">${sub.name}</div>
                                <div class="text-xs text-pink-700 truncate"><i class="fa-solid fa-door-open mr-1"></i>${room.name}</div>
                                <div class="text-xs text-pink-600 mt-1 truncate"><i class="fa-solid fa-chalkboard-user mr-1"></i>${fac.name}</div>
                            </div>
                        `;
                    } else {
                        td.innerHTML = `<div class="h-full w-full border-2 border-dashed border-gray-100 rounded text-gray-300 flex items-center justify-center text-xs opacity-0 hover:opacity-100 transition-opacity">Free Slot</div>`;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }
        }
    </script>
</body>

</html>
